<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>River War</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="River War">
    <style>
        body { margin: 0; padding: 0; background-color: #111; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { position: relative; box-shadow: 0 0 50px rgba(0, 0, 0, 0.8); width: 100%; height: 100%; max-width: 100vw; max-height: 100vh; aspect-ratio: 9/16; }
        canvas { display: block; background-color: #000; width: 100%; height: 100%; image-rendering: pixelated; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; box-sizing: border-box; z-index: 10; }
        .hud-header { width: 100%; height: 15%; min-height: 100px; background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), rgba(0,0,0,0)); display: flex; justify-content: space-between; align-items: flex-start; padding: 20px 20px; box-sizing: border-box; }
        .left-hud { display: flex; flex-direction: column; gap: 10px; width: 50%; }
        .right-hud { text-align: right; width: 50%; }
        .score-text { color: #fff; font-size: clamp(20px, 6vw, 40px); font-weight: 800; letter-spacing: 2px; text-shadow: 2px 2px 0 #000; }
        .timer-text { color: #ffff00; font-size: clamp(18px, 5vw, 32px); font-weight: bold; text-shadow: 1px 1px 0 #000; margin-top: 5px; font-family: 'Courier New', Courier, monospace; }
        #lives-display { display: flex; gap: 5px; padding: 5px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.3); width: fit-content; transform-origin: top left; transform: scale(1.2); }
        .life-icon { width: clamp(25px, 6vw, 35px); height: clamp(25px, 6vw, 35px); background-color: #ff0000; border: 2px solid #555; box-shadow: 0 0 5px rgba(255, 0, 0, 0.5); margin-right: 5px; }
        .fuel-wrapper { width: 100%; max-width: 200px; display: flex; flex-direction: column; align-items: flex-start; }
        .fuel-container { width: 100%; height: 20px; background: rgba(0, 0, 0, 0.5); border: 2px solid #fff; border-radius: 4px; overflow: hidden; }
        #fuel-bar-fill { height: 100%; width: 100%; background-color: #00ffff; transition: width 0.1s linear; }
        #loading-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #fff; z-index: 20; }
        #game-over { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 48px; font-weight: bold; text-align: center; z-index: 15; background: rgba(0,0,0,0.85); padding: 40px; border-radius: 20px; border: 3px solid #fff; width: 80%; }
        .restart-btn { font-size: clamp(24px, 6vw, 36px); padding: 20px 60px; cursor: pointer; pointer-events: auto; background: #fff; border: none; border-radius: 12px; font-weight: bold; color: #111; }
        #start-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; color: white; font-size: 32px; z-index: 18; cursor: pointer; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="720" height="1280"></canvas>
    <div id="ui-layer">
        <div class="hud-header">
            <div class="left-hud">
                <div id="lives-display"></div>
                <div class="fuel-wrapper">
                    <div class="fuel-container"><div id="fuel-bar-fill"></div></div>
                </div>
            </div>
            <div class="right-hud">
                <div id="score-display" class="score-text">SCORE: 0</div>
                <div id="time-display" class="timer-text">TIME: 00:00</div>
            </div>
        </div>
        <div id="game-over">
            <div style="color: #ff3333; margin-bottom: 20px;">GAME OVER</div>
            <div style="margin-bottom: 30px;">SCORE: <span id="final-score">0</span></div>
            <button class="restart-btn" onclick="location.reload()">RESTART</button>
        </div>
    </div>
    <div id="loading-screen">
        <div id="loading-text">Loading Assets...</div>
        <button id="reset-cache-btn" style="margin-top: 20px; padding: 10px; background: #ff3333; color: white; border: none; cursor: pointer; pointer-events: auto;">FIX CACHE</button>
    </div>
    <div id="start-overlay" onclick="startGameClick()">CLICK TO START</div>
</div>

<script>
// --- CONFIGURATION ---
const CONFIG = {
    canvasWidth: 720, canvasHeight: 1280,
    playerSpeed: 450, playerSmoothing: 8.0,
    scrollSpeed: 250, fuelDrainRate: 5, 
    maxFuel: 100, bulletSpeed: 900,
    initialSpawnRate: 2.0
};

const ASSETS = {
    Player: 'player_jet.png', Bullet: 'bullet.png',
    Enemy_Jet: 'enemy_jet.png', Enemy_Heli: 'enemy_heli.png', Enemy_Carrier: 'enemy_carrier.png',
    Explosion: 'explosion.png', FuelStation: 'fuelstation.png'
};

const AUDIO_ASSETS = {
    shot: 'click.mp3', explosion1: 'explosion_1.mp3', explosion2: 'explosion_2.mp3',
    refill: 'powerup.mp3', engine: 'engine.mp3'
};

// --- ASSET LOADER ---
class AssetLoader {
    constructor() {
        this.images = {}; this.audioPool = {};
        this.total = Object.keys(ASSETS).length + Object.keys(AUDIO_ASSETS).length;
        this.loaded = 0;
    }
    loadAll(cb) {
        const check = () => { if (++this.loaded >= this.total) cb(); };
        for (let k in ASSETS) {
            let i = new Image(); i.src = ASSETS[k];
            i.onload = check; i.onerror = check; this.images[k] = i;
        }
        for (let k in AUDIO_ASSETS) {
            let a = new Audio(); a.src = AUDIO_ASSETS[k];
            a.oncanplaythrough = check; a.onerror = check;
            this.audioPool[k] = [a];
            for(let i=0; i<4; i++) this.audioPool[k].push(a.cloneNode());
        }
    }
    getImage(k) { return this.images[k]; }
    play(k) {
        let p = this.audioPool[k]; if (!p) return;
        let s = p.find(a => a.paused) || p[0];
        s.currentTime = 0; s.play().catch(()=>{});
    }
}

// --- ENTITIES ---
class Entity {
    constructor(x, y, w, h, img) {
        this.x = x; this.y = y; this.width = w; this.height = h; this.image = img;
        this.markedForDeletion = false; this.vx = 0; this.vy = 0;
    }
    update(dt) { this.x += this.vx * dt; this.y += this.vy * dt; }
    draw(ctx) { if (this.image) ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
    getBounds() { return { x: this.x + 10, y: this.y + 10, w: this.width - 20, h: this.height - 20 }; }
    collides(other) {
        let a = this.getBounds(), b = other.getBounds();
        return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
    }
}

class Player extends Entity {
    constructor(game) {
        super(310, 1000, 100, 100, game.assets.getImage('Player'));
        this.game = game; this.fuel = 100; this.shootTimer = 0;
    }
    update(dt) {
        let tx = 0;
        if (this.game.input.keys['ArrowLeft']) tx = -CONFIG.playerSpeed;
        if (this.game.input.keys['ArrowRight']) tx = CONFIG.playerSpeed;
        if (this.game.input.touchX !== null) tx = (this.game.input.touchX - (this.x + 50)) * 5;
        this.vx += (tx - this.vx) * CONFIG.playerSmoothing * dt;
        super.update(dt);
        this.x = Math.max(0, Math.min(CONFIG.canvasWidth - this.width, this.x));
        if (this.shootTimer > 0) this.shootTimer -= dt;
        else { this.game.bullets.push(new Bullet(this.x+40, this.y, -1, this.game)); this.shootTimer = 0.25; this.game.assets.play('shot'); }
    }
}

class Bullet extends Entity {
    constructor(x, y, dir, game) {
        super(x, y, 20, 40, game.assets.getImage('Bullet'));
        this.vy = CONFIG.bulletSpeed * dir;
    }
}

class FuelStation extends Entity {
    constructor(x, y, game) {
        super(x, y, 100, 100, game.assets.getImage('FuelStation'));
        this.game = game; this.health = 3; // İstasyon Canı 3
    }
    update(dt) { this.y += CONFIG.scrollSpeed * this.game.getSpeedMultiplier() * dt; if (this.y > 1300) this.markedForDeletion = true; }
}

class Enemy extends Entity {
    constructor(x, y, type, game) {
        let img = game.assets.getImage(type === 'heli' ? 'Enemy_Heli' : 'Enemy_Jet');
        super(x, y, 100, 100, img);
        this.type = type; this.game = game; this.time = 0;
    }
    update(dt) {
        this.time += dt;
        let m = this.game.getSpeedMultiplier();
        this.y += (this.type === 'jet' ? 400 : 200) * m * dt;
        // 2. Dakika Sonrası Helikopter Zig-Zag
        if (this.type === 'heli' && this.game.gameTime > 120) {
            this.x += Math.sin(this.time * 4) * 200 * dt;
        }
        if (this.y > 1300) this.markedForDeletion = true;
    }
}

// --- GAME ENGINE ---
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.assets = new AssetLoader();
        this.input = { keys: {}, touchX: null };
        this.bullets = []; this.enemies = []; this.stations = [];
        this.score = 0; this.lives = 3; this.gameTime = 0; this.paused = true;
        
        window.addEventListener('keydown', e => this.input.keys[e.code] = true);
        window.addEventListener('keyup', e => this.input.keys[e.code] = false);
        this.canvas.addEventListener('touchstart', e => { e.preventDefault(); this.input.touchX = e.touches[0].clientX * (720/window.innerWidth); });
        this.canvas.addEventListener('touchmove', e => { e.preventDefault(); this.input.touchX = e.touches[0].clientX * (720/window.innerWidth); });
        this.canvas.addEventListener('touchend', () => this.input.touchX = null);

        this.assets.loadAll(() => document.getElementById('loading-screen').style.display = 'none');
    }

    getSpeedMultiplier() {
        let t = this.gameTime;
        if (t < 30) return 1.0;
        if (t < 60) return 1.15;
        let stages = Math.floor((t - 60) / 30);
        return 1.15 * Math.pow(1.10, stages + 1); // Kümülatif %10 artış
    }

    start() {
        this.player = new Player(this); this.paused = false;
        document.getElementById('start-overlay').style.display = 'none';
        this.loop();
    }

    update(dt) {
        if (this.paused) return;
        this.gameTime += dt;
        this.player.update(dt);
        this.player.fuel -= CONFIG.fuelDrainRate * dt;

        if (Math.random() < 0.02 * this.getSpeedMultiplier()) {
            this.enemies.push(new Enemy(Math.random() * 600, -100, Math.random() > 0.5 ? 'heli' : 'jet', this));
        }
        if (Math.random() < 0.005) this.stations.push(new FuelStation(Math.random() * 600, -100, this));

        [...this.bullets, ...this.enemies, ...this.stations].forEach(e => e.update(dt));
        
        this.bullets.forEach(b => {
            this.enemies.forEach(e => {
                if (b.collides(e)) { b.markedForDeletion = e.markedForDeletion = true; this.score += 100; this.assets.play('explosion1'); }
            });
            this.stations.forEach(s => {
                if (b.collides(s)) {
                    b.markedForDeletion = true; s.health--; // Yakıt istasyonu HP düşür
                    if (s.health <= 0) { s.markedForDeletion = true; this.assets.play('explosion2'); }
                }
            });
        });

        this.stations.forEach(s => {
            if (this.player.collides(s)) { s.markedForDeletion = true; this.player.fuel = 100; this.assets.play('refill'); }
        });

        if (this.player.fuel <= 0 || this.enemies.some(e => this.player.collides(e))) this.handleDeath();

        this.bullets = this.bullets.filter(b => !b.markedForDeletion);
        this.enemies = this.enemies.filter(e => !e.markedForDeletion);
        this.stations = this.stations.filter(s => !s.markedForDeletion);
        this.updateUI();
    }

    handleDeath() {
        this.lives--; 
        this.player.fuel = 100; // Öldüğünde yakıt fullenir
        this.player.x = 310;
        if (this.lives <= 0) {
            this.paused = true;
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('final-score').innerText = this.score;
        }
    }

    updateUI() {
        document.getElementById('score-display').innerText = `SCORE: ${this.score}`;
        document.getElementById('fuel-bar-fill').style.width = `${Math.max(0, this.player.fuel)}%`;
        let m = Math.floor(this.gameTime / 60), s = Math.floor(this.gameTime % 60);
        document.getElementById('time-display').innerText = `TIME: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        document.getElementById('lives-display').innerHTML = '<div class="life-icon"></div>'.repeat(this.lives);
    }

    draw() {
        this.ctx.fillStyle = '#004488'; this.ctx.fillRect(0,0,720,1280); // Nehir rengi
        this.player.draw(this.ctx);
        [...this.bullets, ...this.enemies, ...this.stations].forEach(e => e.draw(this.ctx));
    }

    loop() {
        let now = Date.now(), dt = (now - (this.last || now)) / 1000; this.last = now;
        this.update(dt); this.draw(); if(!this.paused) requestAnimationFrame(() => this.loop());
    }
}

// Global reset helper for PWA cache
document.getElementById('reset-cache-btn').addEventListener('click', () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(regs => {
            for(let r of regs) r.unregister();
            window.location.reload(true);
        });
    } else { window.location.reload(true); }
});

let g = new Game();
function startGameClick() { g.start(); }
</script>
</body>
</html>
